(function(e){"use strict";e.addEventListener("DOMContentLoaded",function(){i.shanify(this.body),t.mutate(this.body)});const t=function(){const t=function(t){if(t.hasAttribute("src")){const n=null!==e.head.querySelector('script[src="'+t.src+'"]');n||(e.head.appendChild(t),t.addEventListener("load",function(){Function(this.textContent)()}))}else Function(t.textContent)()},n=function(e){if(e instanceof Element){if("SCRIPT"===e.tagName)return t(e);i.shanify(e)}},r=function(e){for(const t of e){let e=t.addedNodes;for(const t of e)n(t);e=t.removedNodes;for(const t of e)o.OBSERVERS.delete(t)}},s=function(e){for(const t of e)t.isIntersecting&&(t.target.dispatchEvent(new Event("demand")),this.disconnect())};return{mutate(e){new MutationObserver(r).observe(e,{subtree:!0,childList:!0})},intersect(e){new IntersectionObserver(s).observe(e)}}}(),n={dispatch(t,r){return r.event=t,e.dispatchEvent(new CustomEvent("shani:"+t,{detail:n.object(r)})),this},object:e=>Object.setPrototypeOf(e||{},null),getType:e=>e?e.substring(e.indexOf("/")+1).split(";")[0]:null,isInput:e=>["INPUT","TEXTAREA"].indexOf(e.tagName)>-1,hasEvent:(e,t)=>t instanceof Map?t.has(e.event)||t.has("*"):t===e.event||"*"===t,explode(e,t){const n=new Map;if(e){const r=e.trim().split(t||"|");for(let e of r){const t=e.indexOf(":"),r=t>0?e.substring(0,t):e;n.set(r.toLowerCase().trim(),t>0?e.substring(t+1).trim():null)}}return n},getReqHeaders(e){const t=n.getType(e.enctype),r=n.explode(e.header);return t&&"form-data"!==t&&r.set("content-type",e.enctype.trim()),r.has("x-request-mode")||r.set("x-request-mode","async"),r},logger(e,t){"true"===e.log&&console.log(t)}},r=function(){const e=function(e,t){const n=t.split(":");if("replace"===n[0])return e.classList.replace(n[1],n[2]);for(let t=1;t<n.length;t++)e.classList[n[0]](n[t])},t=function(e,t,n,r){if("delete"===n)return e.remove();const o="insertAdjacent"+(r?"HTML":"Text");if("remove"===n)return e[o]("afterend",t),e.remove();e[o](n,t)},r=function(e,t,n,r){if("replace"!==n)return!0;"html"===r?e.innerHTML=t:e.textContent=t},o=function(e,t,n){if("first"===n)e.value=t+e.value;else if("last"===n)e.value+=t;else{if("replace"!==n)return!0;e.value=t}},i=function(e){const t=n.explode(e.req.mw);for(const r of t)if(n.hasEvent(e,r[0])){const t=r[1].split(":");for(const r of t)e.resp.data=n.object(new Function("return "+r)().call(e.resp));break}return e.resp.data};return{handleCSS(t){if(t.req.css){const r=n.explode(t.req.css);for(let o of r)n.hasEvent(t,o[0])&&e(t.req.emitter,o[1])}return this},handleData(e){const s=i(e),c=e.req.emitter;if(!s||""===s)return;const a=n.object({before:"beforebegin",after:"afterend",remove:"remove",first:"afterbegin",last:"beforeend",delete:"delete",replace:"replace"})[e.req.insert];if(a){const i=e.resp.headers,l=i?n.getType(i.get("content-type")):null,u=n.isInput(c)?o(c,s,a):r(c,s,a,l);u&&t(c,s,a,"html"===l)}return this},handlePlugin(e){if(e.req.plugin){const t=n.explode(e.req.plugin);for(const r of t)if(n.hasEvent(e,r[0])){const t=r[1].indexOf(":"),o=t>-1?r[1].substring(0,t):r[1];e.params=t>-1?r[1].substring(t+1):null,n.dispatch("plugin:"+o,e)}}return this}}}(),o=function(){const t=function(e,t){const n=e.getAttribute("shani-watch").split(",");for(let r of n)if(t.req.emitter.matches(r))return c.init(e,t)},r=function(e){for(const r of o.OBSERVERS)n.hasEvent(e.detail,r[1])&&t(r[0],e.detail)},i=function(t,i){if(!t.hasAttribute(i))return;let s=t.getAttribute("watch-on");s||(s="init",t.setAttribute("watch-on",s)),s=n.explode(s);for(let t of s)e.addEventListener("shani:"+t[0],r);o.OBSERVERS.set(t,s)};return{OBSERVERS:new Map,watch(e,t){const n="shani-watch";if(t)return i(e,n);c.create(e,n,i)}}}(),i=function(){const r=function(e){const t=e.target.closest("[shani-on~="+e.type+"]");t&&(["A","AREA","FORM"].indexOf(t.tagName)>-1&&e.preventDefault(),c.init(t))},s=function(e){const t=e.querySelectorAll("[name]");for(let e=0;e<t.length&&0===t[e].id.length;e++)t[e].id=t[e].name},a=function(e,t){e.hasAttribute(t)&&("FORM"===e.tagName&&s(e),i.listen(e))};return{listen(o){let i=o.getAttribute("shani-on");if(i){i=n.explode(i);for(const n of i)"load"===n[0]?(o.addEventListener(n[0],r),o.dispatchEvent(new Event(n[0]))):"demand"===n[0]?(o.addEventListener(n[0],r),t.intersect(o)):e.addEventListener(n[0],r)}else i="FORM"===o.tagName?"submit":n.isInput(o)||"SELECT"===o.tagName?"change":"click",o.setAttribute("shani-on",i),e.addEventListener(i,r)},shanify(e,t){const n="shani-fn";t?a(e,n):c.create(e,n,a),o.watch(e,t)}}}(),s=function(){window.Shanify||(window.Shanify=function(t,n,r=!1){if("string"==typeof t&&(t=e.querySelectorAll(t)),!r)for(const e of t)for(let t in n)e.setAttribute(t,n[t]);i.shanify(t,r)});const t=function(e,t,n,r){for(const o of n)e[o]=t.getAttribute(r+o)};return{HTML_ATTR:["enctype","method"],SHANI_ATTR:["mw","target","header","plugin","poll","insert","css","fn","scheme","log"],init(e,r){e.url=r.getAttribute("href")||r.getAttribute("action")||r.value,t(e,r,this.SHANI_ATTR,"shani-"),t(e,r,this.HTML_ATTR,""),e.timer=n.object()}}}(),c=function(){const t=function(e,t){this.srcNode=t?t.req.emitter:null,this.detail=t,this.emitter=e,s.init(this,e),n.dispatch("init",{req:this})};t.prototype={r(){r(this,"GET")},w(){r(this,"POST")},print(){if(window.print instanceof Function){const e=i(this);window.print(),e.remove()}},fs(){if(e.fullscreenEnabled){const t=i(this,35);e.documentElement.requestFullscreen().then(function(){e.addEventListener("fullscreenchange",function(){e.fullscreenElement||t.remove()})}).catch(function(){t.remove()})}},copy(){const t=o(this);if(n.isInput(t))t.select(),e.execCommand("copy");else{const n=e.createElement("TEXTAREA");n.style.width=0,n.style.height=0,e.body.appendChild(n),n.value=t.innerText,n.select(),e.execCommand("copy"),n.remove()}n.dispatch("copy",{req:this})}};const r=function(e,t){if("ws"===e.scheme)return u(e);if("sse"===e.scheme)return f(e);let r=e.emitter;"FORM"===r.tagName&&(r=r.querySelector("fieldset")||r),r.style.opacity=.5,l.send(e,e.method||t,function(t){n.logger(e,t),r.setAttribute("disabled","disabled")},function(t){n.logger(t.req,t.resp),r.removeAttribute("disabled"),r.style.opacity=null,l.fire("end",t).rerun(e,c)})},o=function(t){return t.target?e.querySelector(t.target):t.emitter},i=function(t,n){const r=e.createElement("div"),i=100+(n||0),s=e.createElement("div"),c="shn"+Date.now();r.setAttribute("id",c);let a="body>:not(#"+c+"){display:none}#"+c+"{position:fixed;top:0;left:0;width:100%;";return a+="height:100%;padding:1rem;overflow-y:auto;font-size:"+i+"%;background:#fff;z-index:999;}",r.innerHTML=o(t).outerHTML,r.insertBefore(s,r.firstChild),e.body.insertBefore(r,e.body.firstChild),s.innerHTML=a,r},c=function(e,t){if(e.detail&&!e.fn)return t("ready",{req:e,resp:e.detail.resp});e[e.fn]()};return{init(e,n){if(!e.hasAttribute("disabled")){const r=new t(e,n||null);r.poll&&"ws"!==r.scheme?r.poll&&l.polling(r,c):c(r,l.fire)}},create(e,t,n){const r=e instanceof NodeList?e:e.querySelectorAll("["+t+"]");for(let e=0;e<r.length;e++)n(r[e],t)}}}(),a=function(){const e=function(e){return"string"==typeof e?n.object(JSON.parse(e)):e};return{map2json(e){const t=n.object();for(const n of e)t[n[0]]=n[1];return t},input2form(e){if(["SELECT","INPUT","TEXTAREA"].indexOf(e.tagName)>-1){const t=e.getAttribute("name"),n=new FormData;if(e.files)for(let r=0;r<e.files.length;r++)n.append(t||"file[]",e.files[r]);else n.append(t||"value",e.value);return n}return"FORM"===e.tagName?new FormData(e):null},form2json(e){const t=n.object(),r=[];for(const n of e){if(r.indexOf(n[0])>-1)continue;r.push(n[0]);const o=e.getAll(n[0]),i=n[0].replace(/\[\]/g,"");if(o.length>1){t[i]=[];for(let e of o)t[i].push(e)}else t[i]=o[0]}return t},json2xml(t){const n=function(e,t){let r="<"+t+">";if("object"==typeof e){const o=e instanceof Array;for(let i in e)r+=n(e[i],o?t.replace(/[ ]+/,"-")+(1+parseInt(i)):i)}else r+=e;return r+"</"+t+">"};return'<?xml version="1.0"?>'+n(e(t),"data")},json2yaml(t){const n=function(e,t){let r="";const o=e instanceof Array;for(let i in e){const s="  ".repeat(t)+(o?"-":i+":");"object"!=typeof e[i]?r+=s+" "+e[i]+"\r\n":r+=s+"\r\n"+n(e[i],t+1)}return r};return n(e(t),0).trim()},json2csv(t){const n=function(e){return'"'+(null!==e||void 0!==e?e instanceof Array?e.join("|"):e:"")+'"'};t=e(t);const r=t instanceof Array?t:[t];let o=Object.keys(r[0]).map(n).join(",");for(let e of r){const t=[];for(let r of e)t.push(n(r));o+="\r\n"+t.join(",")}return o},urlencoded(e){const t=[];let n="";for(const r of e){if(t.indexOf(r[0])>-1)continue;const o=e.getAll(r[0]);for(let e of o)n+="&"+r[0]+"="+encodeURIComponent(e);t.push(r[0])}return n.substring(1)},form2(e,t){switch(t){case"json":return JSON.stringify(this.form2json(e));case"xml":return this.json2xml(this.form2json(e));case"yaml":return this.json2yaml(this.form2json(e));case"csv":return this.json2csv(this.form2json(e));case"x-www-form-urlencoded":return this.urlencoded(e)}return e}}}(),l=function(){const e=function(e,r,o){const i=function(e,t){return r.addEventListener(e,t),i};i("readystatechange",function(){4===this.readyState&&l.fire("ready",t(e,r),r.status)})("abort",function(n){l.fire(n.type,t(e,r),410)})("error",function(n){e.timer.limit>0&&e.timer.limit++,l.fire(n.type,t(e,r))})("timeout",function(n){l.fire(n.type,t(e,r),408)})("loadstart",function(n){l.fire(n.type,t(e,r),102)})("loadend",function(){o(t(e,r))}),r.upload.addEventListener("progress",function(o){if(o.lengthComputable){const i=t(e,r);i.bytes=n.object({loaded:o.loaded,total:o.total}),l.fire(o.type,i,102)}})},t=function(e,t){const r=n.object({code:t.status,text:t.statusText});return t.readyState>=4&&(r.data=t.response,r.headers=n.explode(t.getAllResponseHeaders(),"\r\n")),{req:e,resp:r}},o=function(e,t){const r=a.input2form(e.emitter),o=n.object({url:e.url,data:null,headers:n.getReqHeaders(e)});if(r)if("GET"===t.toUpperCase()){const t=e.url.indexOf("?")<0?"?":"&";o.url=e.url+t+a.urlencoded(r)}else{const e=n.getType(o.headers.get("content-type"));o.data=a.form2(r,e)}return o};return{send(t,n,r,i){const s=o(t,n),c=new XMLHttpRequest;r(s.data),c.open(n,s.url,!0);for(const e of s.headers)c.setRequestHeader(e[0],e[1]);e(t,c,i),c.withCredentials=!0,c.send(s.data)},statusText:e=>e?e>199&&e<300?"success":e>299&&e<400?"redirect":e>399&&e<500?"error":e<200?"info":"down":null,redirect(e,t){if(e.url=t.get("location"),t.get("x-ajax")){for(const n of t){if(s.HTML_ATTR.indexOf(n[0])>-1){e[n[0]]=n[1];continue}const t=n[0].substring(n[0].lastIndexOf("-")+1);s.SHANI_ATTR.indexOf(t)>-1&&(e[t]=n[1])}return e.fn=e.fn||"r",e[e.fn]()}"#"===e.url?history.go(0):location=e.url},rerun(e,t){return e.timer.steps>-1&&(!e.timer.limit||--e.timer.limit>0)&&setTimeout(t,e.timer.steps,e,l.fire),this},polling(e,t){const n=e.poll.split(":");e.timer.limit=parseInt(n[2])||null,e.timer.steps=1e3*Number(n[1]||-1),setTimeout(t,1e3*Number(n[0]||0),e,l.fire)},fire(e,t,o){const i=l.statusText(o);if("ready"===e){if("redirect"===i)return l.redirect(t.req,t.resp.headers);r.handleData(t)}return n.dispatch(e,t),o&&n.dispatch(o+"",t).dispatch(i,t),r.handleCSS(t).handlePlugin(t),this}}}(),u=function(){const e=function(e,o){const i=function(e,t){return o.addEventListener(e,t),i},s=function(t,o){const i=n.object({req:e,resp:{data:t.data||null,headers:null}});"success"===o&&r.handleData(i),n.dispatch(o,i),r.handleCSS(i).handlePlugin(i)};i("open",function(n){o.send(t(e)),s(n,"ready")})("message",function(e){s(e,"success")})("error",function(e){s(e,e.type)})("close",function(e){s(e,"end")})},t=function(e){const t=a.input2form(e.emitter);if(t){const r=n.getReqHeaders(e),o=n.getType(r.get("content-type"));return'{"data":'+a.form2(t,o)+',"headers":'+JSON.stringify(a.map2json(r))+"}"}return""};return function(t){const n="http:"===location.protocol?"ws":"wss",r="/"===t.url.charAt(0)?location.host:"",o=new WebSocket(n+"://"+r+t.url);e(t,o)}}(),f=function(){const e=function(e,t){const o=function(e,n){return t.addEventListener(e,n),o},i=function(t,o){const i=n.object({req:e,resp:{data:t.data||null,headers:(new Map).set("content-type","text/html")}});"error"!==o&&"end"!==o&&r.handleData(i),n.dispatch(o,i),r.handleCSS(i).handlePlugin(i)},s=n.explode(e.emitter.getAttribute("shani-on")||"message");for(let e of s)o(e[0],function(e){i(e,e.type)});o("error",function(e){i(e,e.type)})("beforeunload",function(){t.close()})};return function(t){e(t,new EventSource(t.url,{withCredentials:!0}))}}()})(document);